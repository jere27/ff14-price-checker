<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>FF14 å®è–¬G4 åŸä¾¡ãƒã‚§ãƒƒã‚¯</title>
<style>
body { font-family: sans-serif; padding: 20px; max-width: 700px; }
select, button { padding: 8px; margin-right: 5px; }
.materials { margin-left: 20px; line-height: 1.8; }
.note { color: #555; font-size: 13px; }
.price { font-weight: bold; }
</style>
</head>

<body>

<h1>FF14 å®è–¬G4 åŸä¾¡ãƒã‚§ãƒƒã‚«ãƒ¼</h1>

<select id="recipe">
  <option value="goryoku">å‰›åŠ›ã®å®è–¬G4</option>
  <option value="shinryoku">å¿ƒåŠ›ã®å®è–¬G4</option>
</select>

<select id="dc">
  <option value="Mana">Mana</option>
  <option value="Gaia">Gaia</option>
  <option value="Elemental">Elemental</option>
  <option value="Meteor">Meteor</option>
</select>

<button id="fetchBtn">ä¾¡æ ¼å–å¾—</button>

<div id="result"></div>

<script>
const RECIPES = {
  goryoku: {
    name: "å‰›åŠ›ã®å®è–¬G4",
    marketId: 49234,
    materials: [
      { id: 49228, name: "ã‚¤ãƒ¨ãƒ©ã‚¨ã‚­ã‚¹" },
      { id: 44051, name: "å¤§è–æ°´" },
      { id: 44039, name: "ã‚¦ã‚£ãƒ³ãƒ‰ãƒ‘ã‚»ãƒª" },
      { id: 46246, name: "ç´«é›»ã®éœŠç ‚" }
    ]
  },
  shinryoku: {
    name: "å¿ƒåŠ›ã®å®è–¬G4",
    marketId: null,
    materials: [
      { id: 49228, name: "ã‚¤ãƒ¨ãƒ©ã‚¨ã‚­ã‚¹" },
      { id: 44051, name: "å¤§è–æ°´" },
      { id: 44043, name: "ãƒ‘ãƒ¼ãƒ«ã‚°ãƒ©ã‚¹" },
      { id: 46246, name: "ç´«é›»ã®éœŠç ‚" }
    ]
  }
};

async function fetchAvg(dc, id) {
  const res = await fetch(`https://universalis.app/api/v2/${dc}/${id}`);
  if (!res.ok) return null;
  const data = await res.json();
  const list = data.listings || [];
  if (!list.length) return null;

  const hq = list.filter(x => x.hq);
  const use = hq.length ? hq : list;

  const prices = use
    .sort((a,b) => a.pricePerUnit - b.pricePerUnit)
    .slice(0,10)
    .map(x => x.pricePerUnit);

  return Math.round(prices.reduce((a,b)=>a+b,0)/prices.length);
}

async function fetchAll() {
  const recipe = RECIPES[document.getElementById("recipe").value];
  const dc = document.getElementById("dc").value;
  const result = document.getElementById("result");

  result.innerHTML = `<h2>${recipe.name}</h2>`;

  if (recipe.marketId) {
    const sell = await fetchAvg(dc, recipe.marketId);
    if (sell !== null) {
      result.innerHTML += `<div class="price">è²©å£²ç›¸å ´ï¼ˆ1å€‹ï¼‰ï¼š${sell.toLocaleString()} ã‚®ãƒ«</div>`;
    }
  }

  result.innerHTML += `
    <div class="note">â€» 1å›ã®è£½ä½œã§3å€‹å®Œæˆã—ã¾ã™</div>
    <h3>ç´ æï¼ˆ1å›åˆ†ï¼‰</h3>
    <div class="materials"></div>
  `;

  let cost = 0;
  const mat = result.querySelector(".materials");

  for (const item of recipe.materials) {
    const p = await fetchAvg(dc, item.id);
    if (p !== null) {
      cost += p;
      mat.innerHTML += `ãƒ»${item.name}ã€€${p.toLocaleString()} ã‚®ãƒ«<br>`;
    } else {
      mat.innerHTML += `ãƒ»${item.name}ã€€å–å¾—å¤±æ•—<br>`;
    }
  }

  result.innerHTML += `<h3>åŸä¾¡ï¼ˆ1å›åˆ†ï¼‰ï¼š${cost.toLocaleString()} ã‚®ãƒ«</h3>`;
}

// ğŸ”´ ã“ã“ãŒé‡è¦ï¼šãƒœã‚¿ãƒ³ã¨JSã‚’æ¥ç¶š
document.getElementById("fetchBtn").addEventListener("click", fetchAll);
</script>

</body>
</html>
