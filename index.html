<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>FF14 宝薬G4 原価計算</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      max-width: 650px;
    }
    select, button {
      padding: 8px;
      font-size: 14px;
      margin-right: 5px;
    }
    .materials {
      margin-left: 20px;
      margin-top: 10px;
      line-height: 1.9;
    }
    .total {
      margin-top: 15px;
      font-weight: bold;
      font-size: 16px;
    }
    .note {
      color: #555;
      font-size: 13px;
      margin-top: 5px;
    }
  </style>
</head>
<body>

<h1>原価チェッカー</h1>

<label>
  宝薬：
  <select id="recipe-select">
    <option value="goryoku">剛力の宝薬G4</option>
    <option value="shinryoku">心力の宝薬G4</option>
  </select>
</label>

<label>
  DC：
  <select id="dc-select">
    <option value="Mana">Mana</option>
    <option value="Gaia">Gaia</option>
    <option value="Elemental">Elemental</option>
    <option value="Meteor">Meteor</option>
  </select>
</label>

<button onclick="fetchAll()">価格取得</button>

<div id="result"></div>

<script>
  // ===== レシピ定義 =====
  const RECIPES = {
    goryoku: {
      name: "剛力の宝薬G4",
      materials: [
        { id: 49228, name: "イヨラエキス" },
        { id: 44051, name: "大聖水" },
        { id: 44039, name: "ウィンドパセリ" },
        { id: 46246, name: "紫電の霊砂" }
      ]
    },
    shinryoku: {
      name: "心力の宝薬G4",
      materials: [
        { id: 49228, name: "イヨラエキス" },
        { id: 44051, name: "大聖水" },
        { id: 44043, name: "パールグラス" },
        { id: 46246, name: "紫電の霊砂" }
      ]
    }
  };

  async function fetchPrice(dc, item) {
    const url = `https://universalis.app/api/v2/${dc}/${item.id}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error("API取得失敗");

    const data = await res.json();
    const listings = data.listings || [];
    if (listings.length === 0) return null;

    const hq = listings.filter(i => i.hq);
    const nq = listings.filter(i => !i.hq);
    const target = hq.length > 0 ? hq : nq;

    const prices = target
      .sort((a, b) => a.pricePerUnit - b.pricePerUnit)
      .slice(0, 10)
      .map(i => i.pricePerUnit);

    return Math.round(
      prices.reduce((a, b) => a + b, 0) / prices.length
    );
  }

  async function fetchAll() {
    const recipeKey = document.getElementById("recipe-select").value;
    const recipe = RECIPES[recipeKey];
    const dc = document.getElementById("dc-select").value;
    const resultDiv = document.getElementById("result");

    resultDiv.innerHTML = `
      <h2>${recipe.name}</h2>
      <div class="note">※ 作成に必要な素材の平均価格</div>
      <h3>${dc} DC</h3>
      <div class="materials"></div>
    `;

    const materialsDiv = resultDiv.querySelector(".materials");
    let totalCost = 0;

    for (const item of recipe.materials) {
      const price = await fetchPrice(dc, item);

      if (price !== null) {
        totalCost += price;
        materialsDiv.innerHTML +=
          `・${item.name}　${price.toLocaleString()} ギル<br>`;
      } else {
        materialsDiv.innerHTML +=
          `・${item.name}　データなし<br>`;
      }
    }

    resultDiv.innerHTML +=
      `<div class="total">原価合計：${totalCost.toLocaleString()} ギル</div>`;
  }
</script>

</body>
</html>
