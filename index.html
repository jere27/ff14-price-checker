<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>FF14 宝薬G4 原価・利益チェッカー</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      max-width: 700px;
    }
    select, button {
      padding: 8px;
      font-size: 14px;
      margin-right: 5px;
    }
    .materials {
      margin-left: 20px;
      margin-top: 10px;
      line-height: 1.9;
    }
    .section {
      margin-top: 15px;
    }
    .label {
      font-weight: bold;
    }
  </style>
</head>
<body>

<h1>FF14 宝薬G4 原価・利益チェッカー</h1>

<label>
  宝薬：
  <select id="recipe-select">
    <option value="goryoku">剛力の宝薬G4</option>
    <option value="shinryoku">心力の宝薬G4</option>
  </select>
</label>

<label>
  DC：
  <select id="dc-select">
    <option value="Mana">Mana</option>
    <option value="Gaia">Gaia</option>
    <option value="Elemental">Elemental</option>
    <option value="Meteor">Meteor</option>
  </select>
</label>

<button onclick="fetchAll()">価格取得</button>

<div id="result"></div>

<script>
  // ===== 各レシピ =====
  const RECIPES = {
    goryoku: {
      name: "剛力の宝薬G4",
      marketId: 49234,
      materials: [
        { id: 49228, name: "イヨラエキス" },
        { id: 44051, name: "大聖水" },
        { id: 44039, name: "ウィンドパセリ" },
        { id: 46246, name: "紫電の霊砂" }
      ]
    },
    shinryoku: {
      name: "心力の宝薬G4",
      marketId: null, // なし
      materials: [
        { id: 49228, name: "イヨラエキス" },
        { id: 44051, name: "大聖水" },
        { id: 44043, name: "パールグラス" },
        { id: 46246, name: "紫電の霊砂" }
      ]
    }
  };

  async function fetchAvgPrice(dc, id) {
    const url = `https://universalis.app/api/v2/${dc}/${id}`;
    const res = await fetch(url);
    if (!res.ok) return null;
    const data = await res.json();

    const listings = data.listings || [];
    if (listings.length === 0) return null;

    const hq = listings.filter(i => i.hq);
    const nq = listings.filter(i => !i.hq);
    const target = hq.length > 0 ? hq : nq;

    const prices = target
      .sort((a, b) => a.pricePerUnit - b.pricePerUnit)
      .slice(0, 10)
      .map(i => i.pricePerUnit);

    if (prices.length === 0) return null;
    const avg = Math.round(prices.reduce((a,b) => a+b, 0) / prices.length);
    return avg;
  }

  async function fetchAll() {
    const recipeKey = document.getElementById("recipe-select").value;
    const recipe = RECIPES[recipeKey];
    const dc = document.getElementById("dc-select").value;
    const resultDiv = document.getElementById("result");

    resultDiv.innerHTML = `
      <h2>${recipe.name}</h2>
      <div class="section label">DC: ${dc}</div>
    `;

    // 素材価格一覧
    let totalCost = 0;
    resultDiv.innerHTML += `<div class="section label">素材価格</div>`;
    resultDiv.innerHTML += `<div class="materials"></div>`;
    const matDiv = resultDiv.querySelector(".materials");

    for (const item of recipe.materials) {
      const price = await fetchAvgPrice(dc, item.id);
      if (price !== null) {
        totalCost += price;
        matDiv.innerHTML += `・${item.name}　${price.toLocaleString()} ギル<br>`;
      } else {
        matDiv.innerHTML += `・${item.name}　データなし<br>`;
      }
    }

    resultDiv.innerHTML += `<div class="section total">原価合計：${totalCost.toLocaleString()} ギル</div>`;

    // 完成品価格（剛力のみ対応）
    if (recipe.marketId) {
      const sellPrice = await fetchAvgPrice(dc, recipe.marketId);
      if (sellPrice !== null) {
        resultDiv.innerHTML += `<div class="section label">販売平均価格：${sellPrice.toLocaleString()} ギル</div>`;
        const profit = sellPrice - totalCost;
        resultDiv.innerHTML += `<div class="section label">利益：${profit.toLocaleString()} ギル</div>`;
      } else {
        resultDiv.innerHTML += `<div class="section label">販売価格データなし</div>`;
      }
    }
  }
</script>

</body>
</html>
