<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>FF14 宝薬G4 原価計算</title>
<style>
body { font-family: sans-serif; padding: 20px; max-width: 700px; }
button, select { padding: 8px; margin-right: 5px; }
.materials { margin-left: 20px; line-height: 1.8; }
.note { color: #555; font-size: 13px; }
</style>
</head>

<body>

<h1>FF14 宝薬G4 原価・利益チェッカー</h1>

<select id="recipe">
  <option value="goryoku">剛力の宝薬G4</option>
  <option value="shinryoku">心力の宝薬G4</option>
</select>

<select id="dc">
  <option value="Mana">Mana</option>
  <option value="Gaia">Gaia</option>
  <option value="Elemental">Elemental</option>
  <option value="Meteor">Meteor</option>
</select>

<button onclick="fetchAll()">価格取得</button>

<div id="result"></div>

<script>
const OUTPUT = 3;

const RECIPES = {
  goryoku: {
    name: "剛力の宝薬G4",
    marketId: 49234,
    materials: [
      { id: 49228, name: "イヨラエキス" },
      { id: 44051, name: "大聖水" },
      { id: 44039, name: "ウィンドパセリ" },
      { id: 46246, name: "紫電の霊砂" }
    ]
  },
  shinryoku: {
    name: "心力の宝薬G4",
    marketId: null,
    materials: [
      { id: 49228, name: "イヨラエキス" },
      { id: 44051, name: "大聖水" },
      { id: 44043, name: "パールグラス" },
      { id: 46246, name: "紫電の霊砂" }
    ]
  }
};

async function fetchAvg(dc, id) {
  const r = await fetch(`https://universalis.app/api/v2/${dc}/${id}`);
  if (!r.ok) return null;
  const d = await r.json();
  const list = d.listings || [];
  if (!list.length) return null;

  const hq = list.filter(x => x.hq);
  const use = hq.length ? hq : list;

  const prices = use
    .sort((a,b) => a.pricePerUnit - b.pricePerUnit)
    .slice(0,10)
    .map(x => x.pricePerUnit);

  return Math.round(prices.reduce((a,b)=>a+b,0)/prices.length);
}

async function fetchAll() {
  const recipe = RECIPES[document.getElementById("recipe").value];
  const dc = document.getElementById("dc").value;
  const res = document.getElementById("result");

  res.innerHTML = `
    <h2>${recipe.name}</h2>
    <div class="note">※ 1回の製作で ${OUTPUT} 個完成</div>
    <div class="materials"></div>
  `;

  let cost = 0;
  const m = res.querySelector(".materials");

  for (const item of recipe.materials) {
    const p = await fetchAvg(dc, item.id);
    if (p !== null) {
      cost += p;
      m.innerHTML += `・${item.name}　${p.toLocaleString()} ギル<br>`;
    } else {
      m.innerHTML += `・${item.name}　取得失敗<br>`;
    }
  }

  const per = Math.round(cost / OUTPUT);

  res.innerHTML += `
    <p><strong>製作原価（${OUTPUT}個分）：${cost.toLocaleString()} ギル</strong></p>
    <p>1個あたり原価：${per.toLocaleString()} ギル</p>
  `;

  if (recipe.marketId) {
    const sell = await fetchAvg(dc, recipe.marketId);
    if (sell !== null) {
      const profit = sell * OUTPUT - cost;
      res.innerHTML += `
        <p><strong>販売平均価格（1個）：${sell.toLocaleString()} ギル</strong></p>
        <p><strong>利益：${profit.toLocaleString()} ギル</strong></p>
      `;
    }
  }
}
</script>

</body>
</html>
