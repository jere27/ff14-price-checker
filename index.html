<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>FF14 アイテム価格チェッカー（HQ優先）</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      max-width: 700px;
    }
    select, button {
      padding: 8px;
      font-size: 14px;
      margin-right: 5px;
    }
    ul {
      margin-top: 10px;
    }
  </style>
</head>
<body>

  <h1>FF14 アイテム価格チェック（HQ優先）</h1>

  <!-- DC選択 -->
  <label>
    DC：
    <select id="dc-select">
      <option value="Mana">Mana</option>
      <option value="Gaia">Gaia</option>
      <option value="Elemental">Elemental</option>
      <option value="Meteor">Meteor</option>
    </select>
  </label>

  <br><br>

  <!-- アイテム選択 -->
  <label>
    アイテム：
    <select id="item-select"></select>
  </label>

  <button onclick="fetchPrice()">価格取得</button>

  <h2 id="title"></h2>
  <h3 id="average"></h3>
  <ul id="list"></ul>

  <script>
    // ===== アイテム一覧（表示名） =====
    const ITEMS = [
      { id: 49228, name: "イヨラエキス" },
      { id: 44051, name: "大聖水" },
      { id: 44039, name: "ウィンドパセリ" },
      { id: 46246, name: "紫電の霊砂" }
    ];

    function initItems() {
      const select = document.getElementById("item-select");
      ITEMS.forEach(item => {
        const option = document.createElement("option");
        option.value = item.id;
        option.textContent = item.name;
        select.appendChild(option);
      });
    }

    async function fetchPrice() {
      try {
        const selectEl = document.getElementById("item-select");
        const itemId = selectEl.value;
        const itemName = selectEl.options[selectEl.selectedIndex].text;
        const dc = document.getElementById("dc-select").value;

        const url = `https://universalis.app/api/v2/${dc}/${itemId}`;
        const res = await fetch(url);

        if (!res.ok) {
          throw new Error("API取得失敗");
        }

        const data = await res.json();

        if (!data.listings || data.listings.length === 0) {
          alert("出品データがありません");
          return;
        }

        // HQ と NQ に分ける
        const hqListings = data.listings.filter(i => i.hq === true);
        const nqListings = data.listings.filter(i => i.hq === false);

        // HQ優先、なければNQ
        const targetListings = hqListings.length > 0 ? hqListings : nqListings;
        const qualityLabel = hqListings.length > 0 ? "HQ" : "NQ";

        // 安い順に10件
        const sorted = targetListings
          .sort((a, b) => a.pricePerUnit - b.pricePerUnit)
          .slice(0, 10);

        const total = sorted.reduce((sum, i) => sum + i.pricePerUnit, 0);
        const average = Math.round(total / sorted.length);

        // 表示
        document.getElementById("title").textContent =
          `${itemName}（${dc} DC / ${qualityLabel}）`;

        document.getElementById("list").innerHTML =
          sorted.map(i =>
            `<li>${i.pricePerUnit.toLocaleString()} ギル（${i.worldName}）</li>`
          ).join("");

        document.getElementById("average").textContent =
          `${qualityLabel} 安値${sorted.length}件の平均価格：${average.toLocaleString()} ギル`;

      } catch (e) {
        console.error(e);
        alert("エラーが発生しました。Consoleを確認してください");
      }
    }

    window.onload = initItems;
  </script>

</body>
</html>
