<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>剛力の宝薬G4 原価計算</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      max-width: 600px;
    }
    button, select {
      padding: 8px;
      font-size: 14px;
    }
    .item {
      margin-left: 20px;
      line-height: 1.8;
    }
    .total {
      margin-top: 15px;
      font-weight: bold;
      font-size: 16px;
    }
  </style>
</head>
<body>

<h1>剛力の宝薬G4</h1>

<label>
  DC：
  <select id="dc-select">
    <option value="Mana">Mana</option>
    <option value="Gaia">Gaia</option>
    <option value="Elemental">Elemental</option>
    <option value="Meteor">Meteor</option>
  </select>
</label>

<button onclick="fetchAll()">価格取得</button>

<div id="result"></div>

<script>
  // ===== 剛力の宝薬G4 素材 =====
  const MATERIALS = [
    { id: 49228, name: "イヨラエキス" },
    { id: 44051, name: "大聖水" },
    { id: 44039, name: "ウィンドパセリ" },
    { id: 46246, name: "紫電の霊砂" }
  ];

  async function fetchPrice(dc, item) {
    const url = `https://universalis.app/api/v2/${dc}/${item.id}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error("API取得失敗");

    const data = await res.json();
    const listings = data.listings || [];
    if (listings.length === 0) return null;

    const hq = listings.filter(i => i.hq);
    const nq = listings.filter(i => !i.hq);
    const target = hq.length > 0 ? hq : nq;

    const prices = target
      .sort((a, b) => a.pricePerUnit - b.pricePerUnit)
      .slice(0, 10)
      .map(i => i.pricePerUnit);

    return Math.round(
      prices.reduce((a, b) => a + b, 0) / prices.length
    );
  }

  async function fetchAll() {
    const dc = document.getElementById("dc-select").value;
    const resultDiv = document.getElementById("result");

    resultDiv.innerHTML = `<h2>${dc} DC</h2>`;

    let totalCost = 0;

    for (const item of MATERIALS) {
      const price = await fetchPrice(dc, item);

      if (price !== null) {
        totalCost += price;
        resultDiv.innerHTML +=
          `<div class="item">・${item.name}　${price.toLocaleString()} ギル</div>`;
      } else {
        resultDiv.innerHTML +=
          `<div class="item">・${item.name}　データなし</div>`;
      }
    }

    resultDiv.innerHTML +=
      `<div class="total">原価合計：${totalCost.toLocaleString()} ギル</div>`;
  }
</script>

</body>
</html>
