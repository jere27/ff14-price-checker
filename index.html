<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>FF14 宝薬G4 原価チェック</title>
<style>
body { font-family: sans-serif; padding: 20px; max-width: 700px; }
select, button { padding: 8px; margin-right: 5px; }
.materials { margin-left: 20px; line-height: 1.8; }
.note { color: #555; font-size: 13px; }
.price { font-weight: bold; }
.profit { font-weight: bold; color: darkgreen; }
</style>
</head>

<body>

<h1>FF14 宝薬G4 原価チェッカー</h1>

<select id="recipe">
  <option value="goryoku">剛力の宝薬G4</option>
  <option value="shinryoku">心力の宝薬G4</option>
</select>

<select id="dc">
  <option value="Mana">Mana</option>
  <option value="Gaia">Gaia</option>
  <option value="Elemental">Elemental</option>
  <option value="Meteor">Meteor</option>
</select>

<button id="fetchBtn">価格取得</button>

<div id="result"></div>

<script>
const OUTPUT_COUNT = 3;

const RECIPES = {
  goryoku: {
    name: "剛力の宝薬G4",
    marketId: 49234,
    materials: [
      { id: 49228, name: "イヨラエキス" },
      { id: 44051, name: "大聖水" },
      { id: 44039, name: "ウィンドパセリ" },
      { id: 46246, name: "紫電の霊砂" }
    ]
  },
  shinryoku: {
    name: "心力の宝薬G4",
    marketId: null,
    materials: [
      { id: 49228, name: "イヨラエキス" },
      { id: 44051, name: "大聖水" },
      { id: 44043, name: "パールグラス" },
      { id: 46246, name: "紫電の霊砂" }
    ]
  }
};

async function fetchAvg(dc, id) {
  const res = await fetch(`https://universalis.app/api/v2/${dc}/${id}`);
  if (!res.ok) return null;
  const data = await res.json();
  const list = data.listings || [];
  if (!list.length) return null;

  const hq = list.filter(x => x.hq);
  const use = hq.length ? hq : list;

  const prices = use
    .sort((a,b) => a.pricePerUnit - b.pricePerUnit)
    .slice(0,10)
    .map(x => x.pricePerUnit);

  return Math.round(prices.reduce((a,b)=>a+b,0)/prices.length);
}

async function fetchAll() {
  const recipe = RECIPES[document.getElementById("recipe").value];
  const dc = document.getElementById("dc").value;
  const result = document.getElementById("result");

  result.innerHTML = `<h2>${recipe.name}</h2>`;

  let sellPrice = null;
  if (recipe.marketId) {
    sellPrice = await fetchAvg(dc, recipe.marketId);
    if (sellPrice !== null) {
      result.innerHTML += `
        <div class="price">販売相場（1個）：${sellPrice.toLocaleString()} ギル</div>
      `;
    }
  }

  result.innerHTML += `
    <div class="note">※ 1回の製作で${OUTPUT_COUNT}個完成します</div>
    <h3>素材（1回分）</h3>
    <div class="materials"></div>
  `;

  let cost = 0;
  const mat = result.querySelector(".materials");

  for (const item of recipe.materials) {
    const p = await fetchAvg(dc, item.id);
    if (p !== null) {
      cost += p;
      mat.innerHTML += `・${item.name}　${p.toLocaleString()} ギル<br>`;
    } else {
      mat.innerHTML += `・${item.name}　取得失敗<br>`;
    }
  }

  result.innerHTML += `<h3>原価（1回分）：${cost.toLocaleString()} ギル</h3>`;

  if (sellPrice !== null) {
    const profit = sellPrice * OUTPUT_COUNT - cost;
    result.innerHTML += `
      <h3 class="profit">利益（1回分）：${profit.toLocaleString()} ギル</h3>
    `;
  }
}

document.getElementById("fetchBtn").addEventListener("click", fetchAll);
</script>

</body>
</html>
